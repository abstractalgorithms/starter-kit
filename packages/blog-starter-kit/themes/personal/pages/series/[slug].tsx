import { addPublicationJsonLd } from '@starter-kit/utils/seo/addPublicationJsonLd';
import { getAutogeneratedPublicationOG } from '@starter-kit/utils/social/og';
import request from 'graphql-request';
import { GetStaticProps } from 'next';
import Head from 'next/head';
import Link from 'next/link';
import { useMemo, useState } from 'react';
import { Container } from '../../components/container';
import { AppProvider } from '../../components/contexts/appContext';
import { DateFormatter } from '../../components/date-formatter';
import { Footer } from '../../components/footer';
import { Layout } from '../../components/layout';
import { PersonalHeader } from '../../components/personal-theme-header';
import { getFooterPosts } from '../../lib/api/footerData';
import {
	PostFragment,
	PublicationFragment,
	SeriesPostsByPublicationDocument,
	SeriesPostsByPublicationQuery,
	SeriesPostsByPublicationQueryVariables,
} from '../../generated/graphql';

type SeriesInfo = {
	id: string;
	name: string;
	slug: string;
	coverImage?: string | null;
	description?: string | null;
};

type Props = {
	publication: PublicationFragment;
	posts: PostFragment[];
	series: SeriesInfo;
	footerPosts: PostFragment[];
};

const UNCATEGORIZED = '__uncategorized__';

const toTitleCase = (str: string) =>
	str.replace(/\w\S*/g, (w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());

export default function SeriesDetailPage({ publication, posts, series, footerPosts }: Props) {
	const title = `${series.name} - ${publication.title}`;
	const totalReadTime = posts.reduce((sum, p) => sum + (p.readTimeInMinutes ?? 0), 0);
	const latestDate = posts.length > 0
		? posts.reduce((latest, p) => (p.publishedAt > latest ? p.publishedAt : latest), posts[0].publishedAt)
		: null;

	// Build a stable global index map so step numbers always reflect series order
	const globalIndexMap = useMemo(() => {
		const m = new Map<string, number>();
		posts.forEach((p, i) => m.set(p.id, i));
		return m;
	}, [posts]);

	const [activeCategory, setActiveCategory] = useState<string | null>(null);

	const { categories, grouped } = useMemo(() => {
		const order: { slug: string; name: string }[] = [];
		const seenCats = new Set<string>();
		const map = new Map<string, PostFragment[]>();

		// Each post is assigned to its FIRST valid tag only (primary category).
		// This ensures every post appears exactly once — later groups show only the delta.
		for (const post of posts) {
			const tags = (post.tags ?? []).filter((t): t is NonNullable<typeof t> => !!t?.slug);
			const primaryTag = tags[0];

			if (!primaryTag) {
				// No tags → Uncategorized
				if (!seenCats.has(UNCATEGORIZED)) {
					seenCats.add(UNCATEGORIZED);
					order.push({ slug: UNCATEGORIZED, name: 'Uncategorized' });
				}
				map.set(UNCATEGORIZED, [...(map.get(UNCATEGORIZED) ?? []), post]);
			} else {
				// Only add to the primary (first) tag bucket
				if (!seenCats.has(primaryTag.slug)) {
					seenCats.add(primaryTag.slug);
					order.push({ slug: primaryTag.slug, name: toTitleCase(primaryTag.name ?? primaryTag.slug) });
				}
				map.set(primaryTag.slug, [...(map.get(primaryTag.slug) ?? []), post]);
			}
		}

		// Sort by post count descending (majority first); Uncategorized always last
		const sorted = order
			.filter(c => c.slug !== UNCATEGORIZED)
			.sort((a, b) => (map.get(b.slug)?.length ?? 0) - (map.get(a.slug)?.length ?? 0));
		if (seenCats.has(UNCATEGORIZED)) sorted.push({ slug: UNCATEGORIZED, name: 'Uncategorized' });

		return { categories: sorted, grouped: map };
	}, [posts]);

	const visibleCategories = useMemo(
		() => (activeCategory ? categories.filter(c => c.slug === activeCategory) : categories),
		[categories, activeCategory]
	);

	return (
		<AppProvider publication={publication} footerPosts={footerPosts}>
			<Layout>
				<Head>
					<title>{title}</title>
					<meta name="description" content={series.description ?? `Posts in the ${series.name} series`} />
					<meta property="og:title" content={title} />
					<meta property="og:description" content={series.description ?? `Posts in the ${series.name} series`} />
					<meta
						property="og:image"
						content={series.coverImage ?? publication.ogMetaData.image ?? getAutogeneratedPublicationOG(publication)}
					/>
					<meta property="twitter:card" content="summary_large_image" />
					<meta property="twitter:title" content={title} />
					<meta
						property="twitter:image"
						content={series.coverImage ?? publication.ogMetaData.image ?? getAutogeneratedPublicationOG(publication)}
					/>
					<script
						type="application/ld+json"
						dangerouslySetInnerHTML={{ __html: JSON.stringify(addPublicationJsonLd(publication)) }}
					/>
				</Head>
				<Container className="mx-auto w-full">
					<PersonalHeader />
					<div className="max-w-6xl mx-auto w-full px-5 pt-10 pb-20">

						{/* ── Back Navigation ── */}
						<Link
							href="/series"
							className="inline-flex items-center gap-1.5 text-sm text-neutral-400 dark:text-neutral-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors mb-10 group"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 20 20"
								fill="currentColor"
								className="w-4 h-4 group-hover:-translate-x-0.5 transition-transform"
							>
								<path
									fillRule="evenodd"
									d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z"
									clipRule="evenodd"
								/>
							</svg>
							All Series
						</Link>

						{/* ── Series Hero ── */}
						<div className={`flex flex-col ${series.coverImage ? 'md:flex-row md:items-center md:gap-10' : ''} mb-12`}>
							{/* Left: label, title, description, meta */}
							<div className={series.coverImage ? 'flex-1 min-w-0' : 'w-full'}>
								<p className="text-[10px] font-mono uppercase tracking-widest text-blue-500 dark:text-blue-400 mb-2">
									Series
								</p>
								<h1 className="text-4xl md:text-5xl font-extrabold leading-[1.15] tracking-tight text-neutral-900 dark:text-neutral-50 mb-4 capitalize">
									{series.name}
								</h1>
								{series.description && (
									<div
										className="text-lg text-neutral-500 dark:text-neutral-400 leading-relaxed mb-4"
										dangerouslySetInnerHTML={{ __html: series.description }}
									/>
								)}

								{/* Meta row */}
								<div className="flex flex-wrap items-center gap-x-3 gap-y-2 pt-5 border-t border-neutral-100 dark:border-neutral-800">
									<span className="inline-flex items-center gap-1.5 text-sm text-neutral-500 dark:text-neutral-400">
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-3.5 h-3.5">
											<path d="M10.75 16.82A7.462 7.462 0 0115 15.5c.71 0 1.396.098 2.046.282A.75.75 0 0018 15.06v-11a.75.75 0 00-.546-.721A9.006 9.006 0 0015 3a8.963 8.963 0 00-4.25 1.065V16.82zM9.25 4.065A8.963 8.963 0 005 3c-.85 0-1.673.118-2.454.339A.75.75 0 002 4.06v11a.75.75 0 00.954.721A7.506 7.506 0 015 15.5c1.579 0 3.042.487 4.25 1.32V4.065z" />
										</svg>
										{posts.length} article{posts.length !== 1 ? 's' : ''}
									</span>
									{totalReadTime > 0 && (
										<>
											<span className="text-neutral-200 dark:text-neutral-700 select-none">·</span>
											<span className="inline-flex items-center gap-1 text-sm text-neutral-400 dark:text-neutral-500">
												<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-3.5 h-3.5">
													<path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clipRule="evenodd" />
												</svg>
												~{totalReadTime} min total
											</span>
										</>
									)}
									{latestDate && (
										<>
											<span className="text-neutral-200 dark:text-neutral-700 select-none">·</span>
											<span className="text-sm text-neutral-400 dark:text-neutral-500">
												Updated <DateFormatter dateString={latestDate} />
											</span>
										</>
									)}
								</div>
							</div>

							{/* Right: cover image */}
							{series.coverImage && (
								<div className="w-full md:w-2/5 shrink-0 mt-8 md:mt-0 h-52 md:h-64 rounded-xl overflow-hidden ring-1 ring-neutral-200 dark:ring-neutral-800 shadow-sm">
									<img
										src={series.coverImage}
										alt={series.name}
										className="w-full h-full object-cover"
									/>
								</div>
							)}
						</div>

						{/* ── Posts List ── */}
						{posts.length > 0 ? (
							<div className="flex flex-col gap-8">
								{/* Category pill filters */}
								{categories.length > 1 && (
									<div className="flex flex-wrap gap-2">
										<button
											onClick={() => setActiveCategory(null)}
											className={`inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium border transition-colors ${
												activeCategory === null
													? 'bg-blue-600 text-white border-blue-600'
													: 'bg-white dark:bg-neutral-900 text-neutral-600 dark:text-neutral-400 border-neutral-200 dark:border-neutral-700 hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400'
											}`}
										>
											All
										</button>
										{categories.map((cat) => (
											<button
												key={cat.slug}
												onClick={() => setActiveCategory(cat.slug === activeCategory ? null : cat.slug)}
												className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium border transition-colors ${
													activeCategory === cat.slug
														? 'bg-blue-600 text-white border-blue-600'
														: 'bg-white dark:bg-neutral-900 text-neutral-600 dark:text-neutral-400 border-neutral-200 dark:border-neutral-700 hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400'
												}`}
											>
												{cat.name}
												<span className={`text-xs tabular-nums ${
													activeCategory === cat.slug ? 'text-blue-200' : 'text-neutral-400 dark:text-neutral-500'
												}`}>
													{grouped.get(cat.slug)?.length ?? 0}
												</span>
											</button>
										))}
									</div>
								)}

								{/* Grouped category sections */}
								<div className="flex flex-col gap-14">
									{visibleCategories.map((cat) => {
										const catPosts = grouped.get(cat.slug) ?? [];
										if (catPosts.length === 0) return null;
										return (
											<section key={cat.slug}>
												{/* Category heading — only when showing all */}
												{categories.length > 1 && (
													<div className="flex items-center gap-3 mb-6">
														<div className="flex items-center gap-2">
															{cat.slug !== UNCATEGORIZED ? (
																<Link
																	href={`/tag/${cat.slug}`}
																	className="text-lg md:text-xl font-bold text-neutral-900 dark:text-neutral-50 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
																>
																	{cat.name}
																</Link>
															) : (
																<h3 className="text-lg md:text-xl font-bold text-neutral-900 dark:text-neutral-50">
																	{cat.name}
																</h3>
															)}
															<span className="text-sm font-mono text-neutral-400 dark:text-neutral-500">({catPosts.length})</span>
														</div>
														<div className="flex-1 h-px bg-neutral-200 dark:bg-neutral-800" />
													</div>
												)}

												<ol className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 list-none m-0 p-0">
													{catPosts.map((post) => {
														const stepNum = (globalIndexMap.get(post.id) ?? 0) + 1;
														return (
															<li key={post.id} className="m-0 p-0">
																<Link href={`/${post.slug}`} className="group block h-full">
																	<div className="flex flex-col h-full rounded-xl border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 hover:border-blue-500 dark:hover:border-blue-500 hover:shadow-lg dark:hover:shadow-xl transition-all duration-300 overflow-hidden">
																		{/* Cover image with step badge */}
																		<div className="relative w-full h-48 overflow-hidden bg-neutral-100 dark:bg-neutral-800 flex-shrink-0">
																			{post.coverImage?.url ? (
																				<img
																					src={post.coverImage.url}
																					alt={post.title}
																					className="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-300"
																				/>
																			) : (
																				<div className="w-full h-full flex items-center justify-center">
																					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-10 h-10 text-neutral-300 dark:text-neutral-700">
																						<path d="M11.25 4.533A9.707 9.707 0 006 3a9.735 9.735 0 00-3.25.555.75.75 0 00-.5.707v14.25a.75.75 0 001 .707A8.237 8.237 0 016 18.75c1.995 0 3.823.707 5.25 1.886V4.533zM12.75 20.636A8.214 8.214 0 0118 18.75c.966 0 1.89.166 2.75.47a.75.75 0 001-.708V4.262a.75.75 0 00-.5-.707A9.735 9.735 0 0018 3a9.707 9.707 0 00-5.25 1.533v16.103z" />
																				</svg>
																				</div>
																			)}
																			<span className="absolute top-3 left-3 w-8 h-8 rounded-full bg-white/90 dark:bg-neutral-900/90 backdrop-blur-sm flex items-center justify-center text-xs font-bold font-mono text-neutral-600 dark:text-neutral-300 shadow-sm border border-neutral-200 dark:border-neutral-700 group-hover:bg-blue-600 group-hover:text-white group-hover:border-blue-600 transition-colors">
																				{String(stepNum).padStart(2, '0')}
																			</span>
																		</div>
																		{/* Text content */}
																		<section className="flex flex-col items-start gap-3 flex-grow p-5">
																			<h3 className="text-lg font-bold leading-tight tracking-tight text-neutral-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors line-clamp-2">
																				{post.title}
																			</h3>
																			{(post.subtitle || post.brief) && (
																				<p className="text-neutral-600 dark:text-neutral-400 line-clamp-2 text-sm flex-grow leading-relaxed">
																					{post.subtitle || post.brief}
																				</p>
																			)}
																			<div className="flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-neutral-500 dark:text-neutral-400 mt-auto pt-3 border-t border-neutral-200 dark:border-neutral-800 w-full">
																				<time><DateFormatter dateString={post.publishedAt} /></time>
																				<span className="text-neutral-300 dark:text-neutral-600">•</span>
																				<span>{post.readTimeInMinutes} min read</span>
																			</div>
																		</section>
																	</div>
																</Link>
															</li>
														);
													})}
												</ol>
											</section>
										);
									})}
								</div>
							</div>
						) : (
							<div className="flex flex-col items-center justify-center py-20 border border-dashed border-neutral-200 dark:border-neutral-800 rounded-xl">
								<p className="text-[10px] font-mono uppercase tracking-widest text-neutral-400 dark:text-neutral-500 mb-2">
									Coming soon
								</p>
								<p className="text-base text-neutral-500 dark:text-neutral-400">
									No posts in this series yet.
								</p>
							</div>
						)}
					</div>
					<Footer />
				</Container>
			</Layout>
		</AppProvider>
	);
}

type Params = {
	slug: string;
};

export const getStaticProps: GetStaticProps<Props, Params> = async ({ params }) => {
	if (!params) throw new Error('No params');

	const data = await request<SeriesPostsByPublicationQuery, SeriesPostsByPublicationQueryVariables>(
		process.env.NEXT_PUBLIC_HASHNODE_GQL_ENDPOINT,
		SeriesPostsByPublicationDocument,
		{
			host: process.env.NEXT_PUBLIC_HASHNODE_PUBLICATION_HOST,
			seriesSlug: params.slug,
			first: 20,
		},
	);

	const publication = data.publication;
	if (!publication || !publication.series) {
		return { notFound: true };
	}

	const { series } = publication;
	const posts = series.posts.edges.map((edge) => edge.node);
	const footerPosts = await getFooterPosts();

	return {
		props: {
			publication,
			posts,
			series: {
				id: series.id,
				name: series.name,
				slug: series.slug,
				coverImage: series.coverImage ?? null,
				description: series.description?.html ?? null,
			},
			footerPosts,
		},
		revalidate: 1,
	};
};

export async function getStaticPaths() {
	return {
		paths: [],
		fallback: 'blocking',
	};
}
