import { addPublicationJsonLd } from '@starter-kit/utils/seo/addPublicationJsonLd';
import { getAutogeneratedPublicationOG } from '@starter-kit/utils/social/og';
import request from 'graphql-request';
import { GetStaticProps } from 'next';
import Head from 'next/head';
import { Container } from '../components/container';
import { AppProvider } from '../components/contexts/appContext';
import { Footer } from '../components/footer';
import { Layout } from '../components/layout';
import { PersonalHeader } from '../components/personal-theme-header';
import { getFooterPosts } from '../lib/api/footerData';
import {
	MorePostsByPublicationDocument,
	MorePostsByPublicationQuery,
	MorePostsByPublicationQueryVariables,
	PostFragment,
	PostsByPublicationDocument,
	PostsByPublicationQuery,
	PostsByPublicationQueryVariables,
	PublicationByHostDocument,
	PublicationByHostQuery,
	PublicationByHostQueryVariables,
	PublicationFragment,
} from '../generated/graphql';

const GQL_ENDPOINT = process.env.NEXT_PUBLIC_HASHNODE_GQL_ENDPOINT;

type Props = {
	publication: PublicationFragment;
	footerPosts: PostFragment[];
	heroStats: {
		articlesCount: number;
		categoriesCount: number;
		seriesCount: number;
	};
};

export default function AboutPage({ publication, footerPosts, heroStats }: Props) {
	return (
		<AppProvider publication={publication} footerPosts={footerPosts}>
			<Layout>
				<Head>
					<title>About Us - {publication.title}</title>
					<meta
						name="description"
						content={`Learn about ${publication.title}, our mission, and what we write about.`}
					/>
					<meta property="og:title" content={`About Us - ${publication.title}`} />
					<meta
						property="og:description"
						content={`Learn about ${publication.title}, our mission, and what we write about.`}
					/>
					<meta
						property="og:image"
						content={publication.ogMetaData.image || getAutogeneratedPublicationOG(publication)}
					/>
					<meta property="twitter:card" content="summary_large_image" />
					<meta property="twitter:title" content={`About Us - ${publication.title}`} />
					<meta
						property="twitter:description"
						content={`Learn about ${publication.title}, our mission, and what we write about.`}
					/>
					<meta
						property="twitter:image"
						content={publication.ogMetaData.image || getAutogeneratedPublicationOG(publication)}
					/>
					<script
						type="application/ld+json"
						dangerouslySetInnerHTML={{
							__html: JSON.stringify(addPublicationJsonLd(publication)),
						}}
					/>
				</Head>
				<Container className="mx-auto w-full">
					<PersonalHeader />
					<div className="max-w-6xl mx-auto w-full px-5">
						<section className="w-full py-12">
							<div className="w-full">
								<p className="text-sm font-semibold uppercase tracking-wide text-blue-600 dark:text-blue-400 mb-4">
									About Us
								</p>
								<h1 className="text-4xl md:text-5xl font-bold tracking-tight text-neutral-900 dark:text-neutral-50 mb-6">
									{publication.title}
								</h1>
								<p className="text-lg md:text-xl text-neutral-600 dark:text-neutral-300 leading-relaxed">
									We publish practical engineering content on algorithms, system design, and AI.
									 Our goal is to turn complex topics into clear, actionable guides.
								</p>
							</div>
						</section>

						<section className="w-full py-12 border-t border-neutral-200 dark:border-neutral-800">
						<p className="text-sm font-semibold uppercase tracking-wide text-blue-600 dark:text-blue-400 mb-4">
							By the Numbers
						</p>
						<div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
							{[
								{ label: 'Published Articles', value: heroStats.articlesCount },
								{ label: 'Categories', value: heroStats.categoriesCount },
								{ label: 'Series', value: heroStats.seriesCount },
							].map((item) => (
								<div
									key={item.label}
									className="rounded-lg border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 px-5 py-6 text-center"
								>
									<div className="text-3xl md:text-4xl font-bold text-neutral-900 dark:text-neutral-50">
										{item.value}
									</div>
									<div className="text-sm md:text-base text-neutral-600 dark:text-neutral-300 mt-1">
										{item.label}
									</div>
								</div>
							))}
						</div>
					</section>

					<section className="w-full py-12 border-t border-neutral-200 dark:border-neutral-800">
						<div className="grid grid-cols-1 md:grid-cols-2 gap-6">
								<div className="rounded-lg border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 p-6">
									<h2 className="text-2xl font-bold text-neutral-900 dark:text-neutral-50 mb-3">Our Mission</h2>
									<p className="text-neutral-600 dark:text-neutral-300 leading-relaxed">
										Help engineers and students build strong fundamentals and apply them in real-world software systems.
									</p>
								</div>
								<div className="rounded-lg border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 p-6">
									<h2 className="text-2xl font-bold text-neutral-900 dark:text-neutral-50 mb-3">What We Cover</h2>
									<ul className="list-disc pl-5 space-y-2 text-neutral-600 dark:text-neutral-300">
										<li>Algorithms and data structures</li>
										<li>System design and architecture</li>
										<li>Technical interview prep</li>
										<li>LLM and AI engineering</li>
									</ul>
								</div>
							</div>
						</section>

						<section className="w-full py-12 border-t border-neutral-200 dark:border-neutral-800">
							<div className="rounded-lg border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 p-8">
								<h2 className="text-2xl md:text-3xl font-bold text-neutral-900 dark:text-neutral-50 mb-4">
									Why This Blog Exists
								</h2>
								<p className="text-neutral-600 dark:text-neutral-300 leading-relaxed">
									We noticed that many technical articles are either too shallow or too theoretical.
									 This blog focuses on clarity, depth, and practical examples so readers can apply
									 ideas quickly in work and interviews.
								</p>
							</div>
						</section>
					</div>
					<Footer />
				</Container>
			</Layout>
		</AppProvider>
	);
}

export const getStaticProps: GetStaticProps<Props> = async () => {
	const data = await request<PublicationByHostQuery, PublicationByHostQueryVariables>(
		GQL_ENDPOINT,
		PublicationByHostDocument,
		{
			host: process.env.NEXT_PUBLIC_HASHNODE_PUBLICATION_HOST,
		},
	);

	const publication = data.publication;
	if (!publication) {
		return {
			notFound: true,
		};
	}

	const footerPosts = await getFooterPosts();

	// Fetch all posts to compute stats
	const postsData = await request<PostsByPublicationQuery, PostsByPublicationQueryVariables>(
		GQL_ENDPOINT,
		PostsByPublicationDocument,
		{
			first: 20,
			host: process.env.NEXT_PUBLIC_HASHNODE_PUBLICATION_HOST,
		},
	);

	const allPosts: PostFragment[] = [];
	if (postsData.publication) {
		const initialPosts = (postsData.publication.posts.edges ?? []).map((edge) => edge.node);
		allPosts.push(...initialPosts);

		let cursor = postsData.publication.posts.pageInfo.endCursor;
		let hasNextPage = !!postsData.publication.posts.pageInfo.hasNextPage;

		while (hasNextPage && cursor) {
			const nextPage = await request<
				MorePostsByPublicationQuery,
				MorePostsByPublicationQueryVariables
			>(GQL_ENDPOINT, MorePostsByPublicationDocument, {
				first: 20,
				host: process.env.NEXT_PUBLIC_HASHNODE_PUBLICATION_HOST,
				after: cursor,
			});
			if (!nextPage.publication) break;
			const nextPosts = nextPage.publication.posts.edges.map((edge) => edge.node);
			allPosts.push(...nextPosts);
			cursor = nextPage.publication.posts.pageInfo.endCursor;
			hasNextPage = !!nextPage.publication.posts.pageInfo.hasNextPage;
		}
	}

	const categorySlugs = new Set<string>();
	const seriesIds = new Set<string>();
	for (const post of allPosts) {
		for (const tag of post.tags ?? []) {
			categorySlugs.add(tag.slug);
		}
		if (post.series?.id) {
			seriesIds.add(post.series.id);
		}
	}

	const heroStats = {
		articlesCount: allPosts.length,
		categoriesCount: categorySlugs.size,
		seriesCount: seriesIds.size,
	};

	return {
		props: {
			publication,
			footerPosts,
			heroStats,
		},
		revalidate: 1,
	};
};
